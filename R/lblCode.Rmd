---
title: "TESTING"
output: html_document
date: "2023-06-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()


varNames <- data.frame(var=names(pembrolizumab),
                       label=c('Patient ID','Age at study entry','Patient Sex','Study Cohort','Target lesion size at baseline','PD L1 percent','log of tumour size','Baseline ctDNA','Did ctDNA increase or decrease from baseline to cycle 3','Objective Response','Clinical Beneficial Response','Overall survival status', 'Overall survival time in months','Progression free survival status','Progression free survival time in months'))


ctDNA_names <- data.frame(var=names(ctDNA),
                          label=c('Patient ID',
                                  'Study Cohort',
                                  'Change in ctDNA since baseline',
                                  'Number of weeks on treatment',
                                  'Percentage change in tumour measurement'))

options(reportRmd.v_info = list(default=varNames,ctDNA=ctDNA_names))
options(reportRmd.v_info = list(varNames,ctDNA=ctDNA_names))

getOption("reportRmd.variable_info")

setVariableLabels <- function(default,...){
  pars <- as.list(match.call()[-1])
  #check that all labels exist at data frames and that if more than one table is supplied it is named
  if (any(names(pars)=="")) stop("Only the default table may be unnamed. \nTo supply data frame specific labels please provide in the format data=labels.\nSee examples.")
  for (df in pars){
    if (!exists(as.character(df))) stop(paste(df,'does not exist. Please specify a valid data frame for labels. \nSee examples.'))
    if (!inherits(eval(df),'data.frame')) stop(paste(df,'is not a data frame. Variable labels must be specified in a data frame with two columns: variable names and variable labels.'))
    if (ncol(eval(df))!=2) stop(paste(df,'must be a data frame with two columns: variable names and variable labels.'))
  }
  for (nm in setdiff(names(pars),'default')){
    if (!exists(as.character(nm))) stop(paste(nm,' does not exist. Please specify a valid data frame. \nSee examples.'))
    if (!inherits(get0(nm),'data.frame')) stop(paste(nm,'is not a data frame. Please specify the variable labels in the format data=labels.\nSee examples.'))
  }
  if (names(pars)[1]!='default') warning('There is no default variable label table specified. Variable labels will only be matched to the specified table(s).')
  options(reportRmd.v_info = pars)
  
}

setVariableLabels(varNames)
getOption("reportRmd.v_info")

setVariableLabels(varNames,ctDNA=ctDNA_names)
getOption("reportRmd.v_info")

setVariableLabels(ctDNA=ctDNA_names)
getOption("reportRmd.v_info")

test_fun <- function(data){
  getVL(match.call())
}

getVL <- function(call){
   pars <- as.list(call[-1])
   dn <- as.character(pars$data)
   var_info <- getOption("reportRmd.v_info",NULL)
   vL <- NULL
   if (!is.null(var_info)){
     if (dn %in% names(var_info)) vL <- var_info[[dn]]
     if ('default' %in% names(var_info)) vL <- var_info[['default']]
   } else{
     vL <- data.frame(var=names(get0(dn)),lbl=names(get0(dn)))
   } 
  return(eval(vL))
}


```

