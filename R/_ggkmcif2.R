# Survival Curves v2 --------------------------------------------------------------
                                                                                                                                                                                              
                                                                                                                                                                                              #' Plot KM and CIF curves with ggplot
                                                                                                                                                                                              #'
                                                                                                                                                                                              #' This function will plot a KM or CIF curve with option to add the number at
                                                                                                                                                                                              #' risk. You can specify if you want confidence bands, the hazard ratio, and
                                                                                                                                                                                              #' pvalues, as well as the units of time used.
                                                                                                                                                                                              #'
                                                                                                                                                                                              #' Note that for proper pdf output of special characters the following code
                                                                                                                                                                                              #' needs to be included in the first chunk of the rmd
                                                                                                                                                                                              #' knitr::opts_chunk$set(dev="cairo_pdf")
                                                                                                                                                                                              #'
                                                                                                                                                                                              #' @param response character vector with names of columns to use for response
                                                                                                                                                                                              #' @param cov String specifying the column name of stratification variable
                                                                                                                                                                                              #' @param data dataframe containing your data
                                                                                                                                                                                              #' @param pval boolean to specify if you want p-values in the plot (Log Rank
                                                                                                                                                                                              #'   test for KM and Gray's test for CIF)
                                                                                                                                                                                              #' @param conf.curves boolean to specify if you want confidence interval bands
                                                                                                                                                                                              #' @param table Logical value. If TRUE, includes the number at risk table
                                                                                                                                                                                              #' @param xlab String corresponding to xlabel. By default is "Time"
                                                                                                                                                                                              #' @param ylab String corresponding to ylabel. When NULL uses "Survival
                                                                                                                                                                                              #' @param col vector of colours
                                                                                                                                                                                              #' @param times Numeric vector of times for the x-axis probability" for KM
                                                                                                                                                                                              #'   cuves, and "Probability of an event" for CIF
                                                                                                                                                                                              #' @param type string indicating he type of univariate model to fit. The
                                                                                                                                                                                              #'   function will try and guess what type you want based on your response. If
                                                                                                                                                                                              #'   you want to override this you can manually specify the type. Options
                                                                                                                                                                                              #'   include "KM", and ,"CIF"
                                                                                                                                                                                              #' @param plot.event  Which event(s) to plot (1,2, or c(1,2))
                                                                                                                                                                                              #' @param returns boolean indicating if a list with the objects should be
                                                                                                                                                                                              #'   returned. Default is FALSE and plot will be printed
                                                                                                                                                                                              #' @param ... for additional plotting arguments see \link{ggkmcif2Parameters_2025}
                                                                                                                                                                                              #'
                                                                                                                                                                                              #' @name ggkmcif2_2025
                                                                                                                                                                                              #'
                                                                                                                                                                                              #' @importFrom stats median qnorm as.formula pchisq model.matrix time
                                                                                                                                                                                              #' @importFrom cmprsk cuminc
                                                                                                                                                                                              #' @importFrom survival survfit survdiff
                                                                                                                                                                                              #' @importFrom ggplot2 ggplot
                                                                                                                                                                                              #' @importFrom cowplot plot_grid
                                                                                                                                                                                              #' @examples
                                                                                                                                                                                              #' # Simple plot without confidence intervals
                                                                                                                                                                                              #' data("pembrolizumab")
                                                                                                                                                                                              #' ggkmcif2(response = c('os_time','os_status'),
                                                                                                                                                                                              #' cov='cohort',
                                                                                                                                                                                              #' data=pembrolizumab)
                                                                                                                                                                                              #'
                                                                                                                                                                                              #' # Plot with median survival time
                                                                                                                                                                                              #' ggkmcif2(response = c('os_time','os_status'),
                                                                                                                                                                                              #' cov='sex',
                                                                                                                                                                                              #' data=pembrolizumab,
                                                                                                                                                                                              #' median.text = TRUE,median.lines=TRUE,conf.curves=TRUE)
                                                                                                                                                                                              #'
                                                                                                                                                                                              #' # Plot with specified survival times and log-log CI
                                                                                                                                                                                              #' ggkmcif2(response = c('os_time','os_status'),
                                                                                                                                                                                              #' cov='sex',
                                                                                                                                                                                              #' data=pembrolizumab,
                                                                                                                                                                                              #' median.text = FALSE,set.time.text = 'mo OS',
                                                                                                                                                                                              #' set.time = c(12,24),conf.type = 'log-log',conf.curves=TRUE)
                                                                                                                                                                                              #'
                                                                                                                                                                                              #' # KM plot with 95% CI and censor marks
                                                                                                                                                                                              #' ggkmcif2(c('os_time','os_status'),'sex',data = pembrolizumab, type = 'KM',
                                                                                                                                                                                              #' HR=TRUE, HR_pval = TRUE, conf.curves = TRUE,conf.type='log-log',
                                                                                                                                                                                              #' set.time.CI = TRUE, censor.marks=TRUE)
                                                                                                                                                                                              #' @return ggplot object; if table = F then only curves are output; if table =
                                                                                                                                                                                              #'   T then curves and risk table are output together
                                                                                                                                                                                              
                                                                                                                                                                                              ggkmcif2_2025 <- function (response, cov = NULL, data,  pval = TRUE,
                                                                                                                                                                                                conf.curves = FALSE,
                                                                                                                                                                                                table = TRUE,   xlab = "Time", ylab = NULL, col = NULL,
                                                                                                                                                                                                times = NULL, type = NULL, plot.event = 1,returns=FALSE,...)
                                                                                                                                                                                                {
                                                                                                                                                                                                  mainArgs <- as.list(match.call(expand.dots = TRUE)[-1])
                                                                                                                                                                                                  toAdd <- mainArgs[setdiff(names(mainArgs),ls())]
                                                                                                                                                                                                  toAdd <- lapply(toAdd,function(arg){
                                                                                                                                                                                                    if (inherits(arg,"call")) arg <- eval(arg)
                                                                                                                                                                                                    return(arg)
                                                                                                                                                                                                  })
                                                                                                                                                                                                  list2env(toAdd,environment())
                                                                                                                                                                                                  
                                                                                                                                                                                                  # add any arguments from ggkmcif2Parameters not specified in the function call
                                                                                                                                                                                                  # to the function environment
                                                                                                                                                                                                  if (!("strataname" %in% names(mainArgs))) strataname <- ifelse(is.null(cov),"",nicename(cov))
                                                                                                                                                                                                  defaultExtraArgs <- ggkmcif2Parameters(strataname=strataname)
                                                                                                                                                                                                  argsToAdd <- defaultExtraArgs[setdiff(names(defaultExtraArgs),names(mainArgs))]
                                                                                                                                                                                                  argsToAdd <- lapply(argsToAdd,function(arg){
                                                                                                                                                                                                    if (inherits(arg,"call")) arg <- eval(arg)
                                                                                                                                                                                                    return(arg)
                                                                                                                                                                                                  })
                                                                                                                                                                                                  list2env(argsToAdd,environment())
                                                                                                                                                                                                  event <- event[1]
                                                                                                                                                                                                  data <- data.frame(data)
                                                                                                                                                                                                  
                                                                                                                                                                                                  if (!is.null(cov))
                                                                                                                                                                                                  remove <- rowSums(is.na(data[, c(response, cov)])) > 0
                                                                                                                                                                                                  if (is.null(cov))
                                                                                                                                                                                                  remove <- rowSums(is.na(data[, c(response)])) > 0
                                                                                                                                                                                                  data <- data[!remove, ]
                                                                                                                                                                                                  if (print.n.missing == T & sum(remove) == 1) {
                                                                                                                                                                                                    message("1 observation with missing data was removed.")
                                                                                                                                                                                                  }
                                                                                                                                                                                                  else if (print.n.missing == T & sum(remove) > 0)
                                                                                                                                                                                                  message(paste(sum(remove), "observations with missing data were removed."))
                                                                                                                                                                                                  if (!is.factor(data[, cov]) & !is.numeric(data[, cov]) &
                                                                                                                                                                                                  !is.null(cov)) {
                                                                                                                                                                                                    message("Coercing the cov variable to factor")
                                                                                                                                                                                                    data[, cov] <- factor(data[, cov])
                                                                                                                                                                                                  }
                                                                                                                                                                                                  if (is.numeric(data[, cov])) {
                                                                                                                                                                                                    numeric = T
                                                                                                                                                                                                    if (is.null(cut))
                                                                                                                                                                                                    cut <- median(data[, cov], na.rm = T)
                                                                                                                                                                                                    data[, cov] <- factor(ifelse(data[, cov] <= cut, paste0("<=",
                                                                                                                                                                                                    round(cut, 2)), paste0(">", round(cut, 2))), levels = c(paste0("<=",
                                                                                                                                                                                                    round(cut, 2)), paste0(">", round(cut, 2))))
                                                                                                                                                                                                    out_fmt = ifelse(is.null(knitr::pandoc_to()), "html",
                                                                                                                                                                                                    ifelse(knitr::pandoc_to(c("doc", "docx")), "doc",
                                                                                                                                                                                                    ifelse(knitr::is_latex_output(), "latex", "html")))
                                                                                                                                                                                                    #    le_code <- "â‰¤"
                                                                                                                                                                                                    le_code <- "\u2264"
                                                                                                                                                                                                    if (is.null(stratalabs))
                                                                                                                                                                                                    stratalabs = c(paste0(le_code, round(cut, 2)), paste0(">",
                                                                                                                                                                                                    round(cut, 2)))
                                                                                                                                                                                                  }
                                                                                                                                                                                                  data[, cov] <- droplevels(data[, cov])
                                                                                                                                                                                                  if (is.null(stratalabs))
                                                                                                                                                                                                  stratalabs <- levels(data[, cov])
                                                                                                                                                                                                  if (is.null(stratalabs.table))
                                                                                                                                                                                                  stratalabs.table <- stratalabs
                                                                                                                                                                                                  if (!is.null(col) & !is.null(cov) & (event != "col" | length(plot.event) == 1))
                                                                                                                                                                                                  col <- rep(col, length.out = length(levels(data[, cov])))
                                                                                                                                                                                                  if (!is.null(linetype) & !is.null(cov) & (event != "linetype" |length(plot.event) == 1))
                                                                                                                                                                                                  linetype <- rep(linetype, length.out = length(levels(data[, cov])))
                                                                                                                                                                                                  if (is.null(col)) {
                                                                                                                                                                                                    if (length(plot.event) == 1 | event != "col") {
                                                                                                                                                                                                      col_length <- ifelse(is.null(cov), 1, length(levels(data[,cov])))
                                                                                                                                                                                                    }
                                                                                                                                                                                                    else col_length = 2
                                                                                                                                                                                                    col <- color_palette_surv_ggplot(col_length)
                                                                                                                                                                                                  }
                                                                                                                                                                                                  if (length(unique(data[, response[2]])) < 3 & is.null(type))
                                                                                                                                                                                                  type = "KM"
                                                                                                                                                                                                  if (length(unique(data[, response[2]])) >= 3 & is.null(type))
                                                                                                                                                                                                  type = "CIF"
                                                                                                                                                                                                  if (type == "CIF") {
                                                                                                                                                                                                    median.lines = FALSE
                                                                                                                                                                                                    median.text = FALSE
                                                                                                                                                                                                  }
                                                                                                                                                                                                  if (type == "KM") {
                                                                                                                                                                                                    if (is.null(ylab))
                                                                                                                                                                                                    ylab = "Survival Probability"
                                                                                                                                                                                                  }
                                                                                                                                                                                                  else if (type == "CIF") {
                                                                                                                                                                                                    if (is.null(ylab))
                                                                                                                                                                                                    ylab = "Probability of an Event"
                                                                                                                                                                                                  }
                                                                                                                                                                                                  else (stop("Type must be either KM or CIF"))
                                                                                                                                                                                                  if (flip.CIF == T & type == "CIF") {
                                                                                                                                                                                                    median.text = F
                                                                                                                                                                                                    median.lines = F
                                                                                                                                                                                                    set.time.text = NULL
                                                                                                                                                                                                    set.time.line = F
                                                                                                                                                                                                    set.time = NULL
                                                                                                                                                                                                  }
                                                                                                                                                                                                  multiple_lines <- !is.null(cov)
                                                                                                                                                                                                  if (type == "KM" & multiple_lines & (HR | HR_pval)) {
                                                                                                                                                                                                    coxfit <- survival::coxph(as.formula(paste(paste("survival::Surv(",
                                                                                                                                                                                                    response[1], ",", response[2], ")", sep = ""), "~",
                                                                                                                                                                                                    cov, sep = "")), data = data)
                                                                                                                                                                                                    HR_vals <- paste0("HR = ", sapply(seq(length(stratalabs) -
                                                                                                                                                                                                    1), function(i) {
                                                                                                                                                                                                      return(psthr(summary(coxfit)$conf.int[i, c(1, 3,
                                                                                                                                                                                                        4)], y = HR.digits))
                                                                                                                                                                                                      }))
                                                                                                                                                                                                      if (HR)
                                                                                                                                                                                                      stratalabs[-1] <- paste(stratalabs[-1], HR_vals)
                                                                                                                                                                                                      if (HR_pval)
                                                                                                                                                                                                      stratalabs[-1] <- paste(stratalabs[-1], sapply(summary(coxfit)$coef[,
                                                                                                                                                                                                        5], lpvalue2, digits = HR.pval.digits))
                                                                                                                                                                                                        stratalabs[1] <- paste(stratalabs[1], "REF")
                                                                                                                                                                                                      }
                                                                                                                                                                                                      if (type == "CIF" & multiple_lines & (HR | HR_pval) & length(plot.event ==
                                                                                                                                                                                                        1) & plot.event[1] == 1) {
                                                                                                                                                                                                          crrfit <- crrRx(as.formula(paste(paste(response, collapse = "+"),
                                                                                                                                                                                                          "~", cov, sep = "")), data = data)
                                                                                                                                                                                                          HR_vals <- paste0("HR = ", sapply(seq(length(stratalabs) -
                                                                                                                                                                                                          1), function(i) {
                                                                                                                                                                                                            return(psthr(summary(crrfit)$conf.int[i, c(1, 3,
                                                                                                                                                                                                              4)], y = HR.digits))
                                                                                                                                                                                                            }))
                                                                                                                                                                                                            if (HR)
                                                                                                                                                                                                            stratalabs[-1] <- paste(stratalabs[-1], HR_vals)
                                                                                                                                                                                                            if (HR_pval)
                                                                                                                                                                                                            stratalabs[-1] <- paste(stratalabs[-1], sapply(summary(crrfit)$coef[,
                                                                                                                                                                                                              5], lpvalue2, digits = HR.pval.digits))
                                                                                                                                                                                                              stratalabs[1] <- paste(stratalabs[1], "REF")
                                                                                                                                                                                                            }
                                                                                                                                                                                                            if (type == "KM") {
                                                                                                                                                                                                              if (!multiple_lines) {
                                                                                                                                                                                                                sfit <- survival::survfit(as.formula(paste(paste("survival::Surv(",
                                                                                                                                                                                                                response[1], ",", response[2], ")", sep = ""),
                                                                                                                                                                                                                "~", 1, sep = "")), data = data, conf.type = conf.type)
                                                                                                                                                                                                                if (median.lines == T | median.text == TRUE) {
                                                                                                                                                                                                                  median_vals <- summary(sfit)$table["median"]
                                                                                                                                                                                                                  median_lower <- summary(sfit)$table["0.95LCL"]
                                                                                                                                                                                                                  median_upper <- summary(sfit)$table["0.95UCL"]
                                                                                                                                                                                                                  median_txt <- if (median.CI == TRUE) {
                                                                                                                                                                                                                    paste0(round_sprintf(median_vals, digits = median.digits),
                                                                                                                                                                                                                    "(", round_sprintf(median_lower, digits = median.digits),
                                                                                                                                                                                                                    "-", round_sprintf(median_upper, digits = median.digits),
                                                                                                                                                                                                                    ")")
                                                                                                                                                                                                                  }
                                                                                                                                                                                                                  else round_sprintf(median_vals, digits = median.digits)
                                                                                                                                                                                                                }
                                                                                                                                                                                                                if (!is.null(set.time.text) | set.time.line == TRUE) {
                                                                                                                                                                                                                  set.surv.text = NULL
                                                                                                                                                                                                                  set.surv = NULL
                                                                                                                                                                                                                  for (time_i in set.time) {
                                                                                                                                                                                                                    sum <- summary(sfit, time = c(0, time_i))
                                                                                                                                                                                                                    df_text <- data.frame(time = sum$time)
                                                                                                                                                                                                                    df_text$set.CI <- if (set.time.CI == TRUE) {
                                                                                                                                                                                                                      paste0(round_sprintf(sum$surv, digits = set.time.digits),
                                                                                                                                                                                                                      "(", round_sprintf(sum$lower, digits = set.time.digits),
                                                                                                                                                                                                                      "-", round_sprintf(sum$upper, digits = set.time.digits),
                                                                                                                                                                                                                      ")")
                                                                                                                                                                                                                    }
                                                                                                                                                                                                                    else round_sprintf(sum$surv, digits = set.time.digits)
                                                                                                                                                                                                                    keep_sum <- df_text
                                                                                                                                                                                                                    if (length(sum$surv) > 1)
                                                                                                                                                                                                                    keep_sum <- df_text[sum$time != 0, ]
                                                                                                                                                                                                                    keep_sum$set.CI[keep_sum$time == 0] <- NA
                                                                                                                                                                                                                    set.surv <- rbind(set.surv, keep_sum)
                                                                                                                                                                                                                    if (is.null(set.surv.text)) {
                                                                                                                                                                                                                      set.surv.text <- paste0(time_i, " ", set.time.text,
                                                                                                                                                                                                                      "=", keep_sum$set.CI)
                                                                                                                                                                                                                    }
                                                                                                                                                                                                                    else set.surv.text <- paste0(set.surv.text,
                                                                                                                                                                                                                      ",", time_i, " ", set.time.text, "=", keep_sum$set.CI)
                                                                                                                                                                                                                    }
                                                                                                                                                                                                                  }
                                                                                                                                                                                                                  stratalabs <- "All"
                                                                                                                                                                                                                }
                                                                                                                                                                                                                else {
                                                                                                                                                                                                                  sfit <- survival::survfit(as.formula(paste(paste("survival::Surv(",
                                                                                                                                                                                                                  response[1], ",", response[2], ")", sep = ""),
                                                                                                                                                                                                                  "~", cov, sep = "")), data = data, conf.type = conf.type)
                                                                                                                                                                                                                  if (median.lines == T | median.text == TRUE) {
                                                                                                                                                                                                                    median_vals <- summary(sfit)$table[, "median"]
                                                                                                                                                                                                                    median_lower <- summary(sfit)$table[, "0.95LCL"]
                                                                                                                                                                                                                    median_upper <- summary(sfit)$table[, "0.95UCL"]
                                                                                                                                                                                                                    med_txt <- if (median.CI == TRUE) {
                                                                                                                                                                                                                      paste0(round_sprintf(median_vals, digits = median.digits),
                                                                                                                                                                                                                      "(", round_sprintf(median_lower, digits = median.digits),
                                                                                                                                                                                                                      "-", round_sprintf(median_upper, digits = median.digits),
                                                                                                                                                                                                                      ")")
                                                                                                                                                                                                                    }
                                                                                                                                                                                                                    else round_sprintf(median_vals, digits = median.digits)
                                                                                                                                                                                                                    if (median.text == TRUE)
                                                                                                                                                                                                                    stratalabs <- paste(stratalabs, ", Median=",
                                                                                                                                                                                                                    med_txt)
                                                                                                                                                                                                                  }
                                                                                                                                                                                                                  if (!is.null(set.time.text) | set.time.line == TRUE) {
                                                                                                                                                                                                                    final.set.text = NULL
                                                                                                                                                                                                                    set.surv = NULL
                                                                                                                                                                                                                    for (time_i in set.time) {
                                                                                                                                                                                                                      sum <- summary(sfit, time = c(0, time_i))
                                                                                                                                                                                                                      df_text <- data.frame(strat = sum$strata,
                                                                                                                                                                                                                        time = sum$time)
                                                                                                                                                                                                                        df_text$set.CI <- if (set.time.CI == TRUE) {
                                                                                                                                                                                                                          paste0(round_sprintf(sum$surv, digits = set.time.digits),
                                                                                                                                                                                                                          "(", round_sprintf(sum$lower, digits = set.time.digits),
                                                                                                                                                                                                                          "-", round_sprintf(sum$upper, digits = set.time.digits),
                                                                                                                                                                                                                          ")")
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        else round_sprintf(sum$surv, digits = set.time.digits)
                                                                                                                                                                                                                        dup_strata = sum$strata[duplicated(sum$strata)]
                                                                                                                                                                                                                        keep_sum <- df_text[!(sum$strata %in% dup_strata) |
                                                                                                                                                                                                                          sum$time != 0, ]
                                                                                                                                                                                                                          keep_sum$set.CI[keep_sum$time == 0] <- NA
                                                                                                                                                                                                                          set.surv <- rbind(set.surv, keep_sum)
                                                                                                                                                                                                                          if (is.null(final.set.text)) {
                                                                                                                                                                                                                            final.set.text <- paste0(time_i, " ", set.time.text,
                                                                                                                                                                                                                            "=", keep_sum$set.CI)
                                                                                                                                                                                                                          }
                                                                                                                                                                                                                          else final.set.text <- paste0(final.set.text,
                                                                                                                                                                                                                            ",", time_i, " ", set.time.text, "=", keep_sum$set.CI)
                                                                                                                                                                                                                          }
                                                                                                                                                                                                                          if (!is.null(set.time.text))
                                                                                                                                                                                                                          stratalabs <- paste0(stratalabs, ", ", final.set.text)
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                      }
                                                                                                                                                                                                                      df <- NULL
                                                                                                                                                                                                                      df <- data.frame(time = sfit$time, n.risk = sfit$n.risk,
                                                                                                                                                                                                                        n.censor = sfit$n.censor, n.event = sfit$n.event,
                                                                                                                                                                                                                        surv = sfit$surv, strata = if (multiple_lines) {
                                                                                                                                                                                                                          summary(sfit, censored = T)$strata
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        else factor("All"), upper = if (conf.type != "none" &
                                                                                                                                                                                                                        conf.curves == TRUE) {
                                                                                                                                                                                                                          sfit$upper
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        else factor(NA), lower = if (conf.type != "none" &
                                                                                                                                                                                                                        conf.curves == TRUE) {
                                                                                                                                                                                                                          sfit$lower
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        else factor(NA))
                                                                                                                                                                                                                        levels(df$strata) <- stratalabs
                                                                                                                                                                                                                        zeros <- data.frame(time = 0, surv = 1, strata = if (multiple_lines) {
                                                                                                                                                                                                                          levels(df$strata)
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        else factor("All"), upper = 1, lower = 1)
                                                                                                                                                                                                                        df <- plyr::rbind.fill(zeros, df)
                                                                                                                                                                                                                        df$strata <- factor(df$strata, levels = stratalabs)
                                                                                                                                                                                                                      }
                                                                                                                                                                                                                      if (type == "CIF") {
                                                                                                                                                                                                                        median_time_to_event <- function(name) {
                                                                                                                                                                                                                          estall = get(name, fit)$est
                                                                                                                                                                                                                          timall = get(name, fit)$time
                                                                                                                                                                                                                          return(timall[estall >= 0.5][1])
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        if (!multiple_lines) {
                                                                                                                                                                                                                          invisible(utils::capture.output(fit <- cuminc(data[,
                                                                                                                                                                                                                            response[1]], data[, response[2]])))
                                                                                                                                                                                                                            stratalabs <- " "
                                                                                                                                                                                                                            gsep = " "
                                                                                                                                                                                                                            last_character <- substr(names(fit), nchar(names(fit)),
                                                                                                                                                                                                                            nchar(names(fit)))
                                                                                                                                                                                                                            get_values <- names(fit)[last_character %in% plot.event]
                                                                                                                                                                                                                            if (median.lines == T | median.text == TRUE) {
                                                                                                                                                                                                                              median_vals = sapply(get_values, median_time_to_event)
                                                                                                                                                                                                                              median_txt <- round_sprintf(median_vals, digits = median.digits)
                                                                                                                                                                                                                            }
                                                                                                                                                                                                                            if (!is.null(set.time.text) | set.time.line == TRUE) {
                                                                                                                                                                                                                              set.surv.text = NULL
                                                                                                                                                                                                                              set.surv = NULL
                                                                                                                                                                                                                              for (time_i in set.time) {
                                                                                                                                                                                                                                z <- qnorm(1 - (1 - 0.95)/2)
                                                                                                                                                                                                                                val <- cmprsk::timepoints(fit, times = time_i)$est[rownames(cmprsk::timepoints(fit,
                                                                                                                                                                                                                                  times = time_i)$est) %in% get_values, ]
                                                                                                                                                                                                                                  var <- cmprsk::timepoints(fit, times = time_i)$var[rownames(cmprsk::timepoints(fit,
                                                                                                                                                                                                                                    times = time_i)$est) %in% get_values, ]
                                                                                                                                                                                                                                    lower <- val^exp(-z * sqrt(var)/(val * log(val)))
                                                                                                                                                                                                                                    upper <- val^exp(z * sqrt(var)/(val * log(val)))
                                                                                                                                                                                                                                    keep_sum <- data.frame(val, time_i)
                                                                                                                                                                                                                                    names(keep_sum)[1] <- "value"
                                                                                                                                                                                                                                    keep_sum$set.CI <- if (set.time.CI == TRUE) {
                                                                                                                                                                                                                                      paste0(round_sprintf(val, digits = set.time.digits),
                                                                                                                                                                                                                                      "(", round_sprintf(lower, digits = set.time.digits),
                                                                                                                                                                                                                                      "-", round_sprintf(upper, digits = set.time.digits),
                                                                                                                                                                                                                                      ")")
                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                    else round_sprintf(val, digits = set.time.digits)
                                                                                                                                                                                                                                    if (is.null(set.surv.text)) {
                                                                                                                                                                                                                                      set.surv.text <- paste0(time_i, " ", set.time.text,
                                                                                                                                                                                                                                      "=", keep_sum$set.CI)
                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                    else set.surv.text <- paste0(set.surv.text,
                                                                                                                                                                                                                                      ",", time_i, " ", set.time.text, "=", keep_sum$set.CI)
                                                                                                                                                                                                                                      set.surv <- rbind(keep_sum, set.surv)
                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                  if (table) {
                                                                                                                                                                                                                                    temp <- data
                                                                                                                                                                                                                                    temp[, response[2]][temp[, response[2]] > 0] <- 1
                                                                                                                                                                                                                                    sfit <- survival::survfit(as.formula(paste(paste("Surv(",
                                                                                                                                                                                                                                    response[1], ",", response[2], ")", sep = ""),
                                                                                                                                                                                                                                    "~", 1, sep = "")), data = temp)
                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                else {
                                                                                                                                                                                                                                  newgpvar <- paste0(data[, cov], ":")
                                                                                                                                                                                                                                  newgpvar <- factor(newgpvar, levels = paste0(levels(data[,
                                                                                                                                                                                                                                    cov]), ":"))
                                                                                                                                                                                                                                    invisible(utils::capture.output(fit <- cuminc(data[,
                                                                                                                                                                                                                                      response[1]], data[, response[2]], newgpvar)))
                                                                                                                                                                                                                                      gsep = ": "
                                                                                                                                                                                                                                      last_character <- substr(names(fit), nchar(names(fit)),
                                                                                                                                                                                                                                      nchar(names(fit)))
                                                                                                                                                                                                                                      get_values <- names(fit)[last_character %in% plot.event]
                                                                                                                                                                                                                                      if (median.lines == T | median.text == TRUE)
                                                                                                                                                                                                                                      median_vals <- sapply(get_values, median_time_to_event)
                                                                                                                                                                                                                                      if (median.text == T & length(plot.event) == 1)
                                                                                                                                                                                                                                      stratalabs <- paste(stratalabs, ", Median=",
                                                                                                                                                                                                                                      round_sprintf(median_vals, digits = median.digits))
                                                                                                                                                                                                                                      if (!is.null(set.time.text) | set.time.line == TRUE) {
                                                                                                                                                                                                                                        set.surv.text = NULL
                                                                                                                                                                                                                                        set.surv = NULL
                                                                                                                                                                                                                                        for (time_i in set.time) {
                                                                                                                                                                                                                                          z <- qnorm(1 - (1 - 0.95)/2)
                                                                                                                                                                                                                                          val <- cmprsk::timepoints(fit, times = time_i)$est[rownames(cmprsk::timepoints(fit,
                                                                                                                                                                                                                                            times = time_i)$est) %in% get_values, ]
                                                                                                                                                                                                                                            var <- cmprsk::timepoints(fit, times = time_i)$var[rownames(cmprsk::timepoints(fit,
                                                                                                                                                                                                                                              times = time_i)$est) %in% get_values, ]
                                                                                                                                                                                                                                              lower <- val^exp(-z * sqrt(var)/(val * log(val)))
                                                                                                                                                                                                                                              upper <- val^exp(z * sqrt(var)/(val * log(val)))
                                                                                                                                                                                                                                              keep_sum <- data.frame(val, time_i)
                                                                                                                                                                                                                                              names(keep_sum)[1] <- "value"
                                                                                                                                                                                                                                              keep_sum$set.CI <- if (set.time.CI == TRUE) {
                                                                                                                                                                                                                                                paste0(round_sprintf(val, digits = set.time.digits),
                                                                                                                                                                                                                                                "(", round_sprintf(lower, digits = set.time.digits),
                                                                                                                                                                                                                                                "-", round_sprintf(upper, digits = set.time.digits),
                                                                                                                                                                                                                                                ")")
                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                              else round_sprintf(val, digits = set.time.digits)
                                                                                                                                                                                                                                              if (is.null(set.surv.text)) {
                                                                                                                                                                                                                                                set.surv.text <- paste0(time_i, " ", set.time.text,
                                                                                                                                                                                                                                                "=", keep_sum$set.CI)
                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                              else set.surv.text <- paste0(set.surv.text,
                                                                                                                                                                                                                                                ",", time_i, " ", set.time.text, "=", keep_sum$set.CI)
                                                                                                                                                                                                                                                set.surv <- rbind(keep_sum, set.surv)
                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                            if (!is.null(set.time.text) & length(plot.event) ==
                                                                                                                                                                                                                                            1)
                                                                                                                                                                                                                                            stratalabs <- paste0(stratalabs, ", ", set.surv.text)
                                                                                                                                                                                                                                            if (table) {
                                                                                                                                                                                                                                              temp <- data
                                                                                                                                                                                                                                              temp[, response[2]][temp[, response[2]] > 0] <- 1
                                                                                                                                                                                                                                              sfit <- survival::survfit(as.formula(paste(paste("Surv(",
                                                                                                                                                                                                                                              response[1], ",", response[2], ")", sep = ""),
                                                                                                                                                                                                                                              "~", cov, sep = "")), data = temp)
                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                          if (!is.null(fit$Tests)) {
                                                                                                                                                                                                                                            test <- fit$Test
                                                                                                                                                                                                                                            fit <- fit[names(fit) != "Tests"]
                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                          fit2 <- lapply(fit, `[`, 1:3)
                                                                                                                                                                                                                                          gnames <- names(fit2)
                                                                                                                                                                                                                                          fit2_list <- lapply(seq_along(gnames), function(ind) {
                                                                                                                                                                                                                                            df <- as.data.frame(fit2[[ind]])
                                                                                                                                                                                                                                            df$name <- gnames[ind]
                                                                                                                                                                                                                                            df
                                                                                                                                                                                                                                          })
                                                                                                                                                                                                                                          df <- do.call(rbind, fit2_list)
                                                                                                                                                                                                                                          df$event <- sapply(strsplit(df$name, split = gsep),
                                                                                                                                                                                                                                          `[`, 2)
                                                                                                                                                                                                                                          df$strata <- sapply(strsplit(df$name, split = gsep),
                                                                                                                                                                                                                                          `[`, 1)
                                                                                                                                                                                                                                          df$strata <- factor(df$strata, levels = levels(data[,
                                                                                                                                                                                                                                            cov]))
                                                                                                                                                                                                                                            levels(df$strata) <- stratalabs
                                                                                                                                                                                                                                            if (multiple_lines) {
                                                                                                                                                                                                                                              df$strata <- factor(df$strata, levels = stratalabs)
                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                            else df$strata <- "ALL"
                                                                                                                                                                                                                                            df$std <- std <- sqrt(df$var)
                                                                                                                                                                                                                                            names(df)[names(df) == "est"] <- "surv"
                                                                                                                                                                                                                                            df <- df[df$event %in% plot.event, ]
                                                                                                                                                                                                                                            df$upper <- NA
                                                                                                                                                                                                                                            df$lower <- NA
                                                                                                                                                                                                                                            if (conf.type != "log" & conf.type != "none")
                                                                                                                                                                                                                                            message("Only log confidence intervals avaliable for CIF")
                                                                                                                                                                                                                                            if (conf.type == "log") {
                                                                                                                                                                                                                                              z <- qnorm(1 - (1 - 0.95)/2)
                                                                                                                                                                                                                                              df$lower <- df$surv^exp(-z * sqrt(df$var)/(df$surv *
                                                                                                                                                                                                                                                log(df$surv)))
                                                                                                                                                                                                                                                df$upper <- df$surv^exp(z * sqrt(df$var)/(df$surv *
                                                                                                                                                                                                                                                  log(df$surv)))
                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                if (flip.CIF) {
                                                                                                                                                                                                                                                  df$surv <- 1 - df$surv
                                                                                                                                                                                                                                                  df$upper <- 1 - df$upper
                                                                                                                                                                                                                                                  df$lower <- 1 - df$lower
                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                if (!is.null(eventlabs)) {
                                                                                                                                                                                                                                                  df$event <- factor(df$event)
                                                                                                                                                                                                                                                  levels(df$event) <- eventlabs
                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                else eventlabs <- c(1, 2)
                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                              m <- max(nchar(stratalabs))
                                                                                                                                                                                                                                              maxxval = max(df$time, times[length(times)])
                                                                                                                                                                                                                                              if (is.null(xlim)) {
                                                                                                                                                                                                                                                maxxlim = maxxval
                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                              else {
                                                                                                                                                                                                                                                if (length(xlim) != 2 | !is.numeric(xlim))
                                                                                                                                                                                                                                                stop("xlim must be a numeric vector of length 2.")
                                                                                                                                                                                                                                                maxxlim = xlim[2]
                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                              linetype_name <- col_name <- strataname
                                                                                                                                                                                                                                              leg.pos <- legend.pos
                                                                                                                                                                                                                                              d <- length(levels(df$strata))
                                                                                                                                                                                                                                              if (!multiple_lines & (type == "KM" | (type == "CIF" & length(plot.event) ==
                                                                                                                                                                                                                                              1))) {
                                                                                                                                                                                                                                                leg.pos <- "none"
                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                              else if (is.null(legend.pos)) {
                                                                                                                                                                                                                                                if (type == "CIF" & flip.CIF == F) {
                                                                                                                                                                                                                                                  leg.pos <- c(min(0.1 + m/200, 0.5), 0.9 - d * 0.05)
                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                else leg.pos <-  c(min(0.1 + m/200, 0.5), 0.05 + d *
                                                                                                                                                                                                                                                0.05)
                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                              if (is.null(times))
                                                                                                                                                                                                                                              times <- break_function(maxxlim)
                                                                                                                                                                                                                                              if (type == "CIF" & length(plot.event) > 1) {
                                                                                                                                                                                                                                                if (is.null(event.name))
                                                                                                                                                                                                                                                event.name <- "event"
                                                                                                                                                                                                                                                if (event == "linetype") {
                                                                                                                                                                                                                                                  p <- ggplot(df) + geom_step(aes(time, surv, color = strata,
                                                                                                                                                                                                                                                    linetype = event), size = lsize)
                                                                                                                                                                                                                                                    linetype_name = event.name
                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                  if (event == "col") {
                                                                                                                                                                                                                                                    p <- ggplot(df) + geom_step(aes(time, surv, color = event,
                                                                                                                                                                                                                                                      linetype = strata), size = lsize)
                                                                                                                                                                                                                                                      col_name = event.name
                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                  else {
                                                                                                                                                                                                                                                    p <- ggplot(df) + geom_step(aes(time, surv, group = strata,
                                                                                                                                                                                                                                                      linetype = linetype, col = strata), size = lsize)
                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                    if (conf.type != "none" & conf.curves == TRUE) {
                                                                                                                                                                                                                                                      if (type == "KM")
                                                                                                                                                                                                                                                      p <- p + geom_ribbon(data = df[!is.na(df$upper) &
                                                                                                                                                                                                                                                        !is.na(df$lower), ], aes(x = time, fill = strata,
                                                                                                                                                                                                                                                          ymin = lower, ymax = upper), inherit.aes = FALSE,
                                                                                                                                                                                                                                                          alpha = 0.2, show.legend = F)
                                                                                                                                                                                                                                                          if (type == "CIF" & (event == "linetype" | length(plot.event) ==
                                                                                                                                                                                                                                                          1)) {
                                                                                                                                                                                                                                                            for (evnt in unique(df$event)) {
                                                                                                                                                                                                                                                              p <- p + geom_ribbon(data = df[!is.na(df$upper) &
                                                                                                                                                                                                                                                                !is.na(df$lower) & df$event == evnt, ], aes(x = time,
                                                                                                                                                                                                                                                                  fill = strata, ymin = lower, ymax = upper),
                                                                                                                                                                                                                                                                  inherit.aes = FALSE, alpha = 0.2, show.legend = F)
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                              if (type == "CIF" & event == "col" & length(plot.event) >
                                                                                                                                                                                                                                                              1) {
                                                                                                                                                                                                                                                                for (stra in unique(df$strata)) {
                                                                                                                                                                                                                                                                  p <- p + geom_ribbon(data = df[!is.na(df$upper) &
                                                                                                                                                                                                                                                                    !is.na(df$lower) & df$strata == stra, ], aes(x = time,
                                                                                                                                                                                                                                                                      fill = event, ymin = lower, ymax = upper),
                                                                                                                                                                                                                                                                      inherit.aes = FALSE, alpha = 0.2, show.legend = F)
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                p <- p + theme_classic(base_size = fsize) + theme(axis.text.x = element_text(margin = margin(t = 0),
                                                                                                                                                                                                                                                                vjust = 1), axis.text.x.top = element_text(margin = margin(b = 0),
                                                                                                                                                                                                                                                                vjust = 0), axis.text.y = element_text(margin = margin(r = 0),
                                                                                                                                                                                                                                                                hjust = 1), axis.text.y.right = element_text(margin = margin(l = 0),
                                                                                                                                                                                                                                                                hjust = 0), axis.title.x.bottom = element_text(vjust = 4)) +
                                                                                                                                                                                                                                                                scale_x_continuous(paste0("\n", xlab), breaks = times,
                                                                                                                                                                                                                                                                limits = c(0, maxxval)) + coord_cartesian(xlim = c(0,
                                                                                                                                                                                                                                                                  maxxlim)) +
                                                                                                                                                                                                                                                                  scale_y_continuous(paste0(ylab, "\n"), limits = ylim) +
                                                                                                                                                                                                                                                                  theme(panel.grid.minor = element_blank()) +
                                                                                                                                                                                                                                                                  theme(legend.key = element_rect(colour = "transparent",
                                                                                                                                                                                                                                                                  fill = "transparent"), legend.background = element_blank(),
                                                                                                                                                                                                                                                                  legend.position = leg.pos) +
                                                                                                                                                                                                                                                                  labs(linetype = linetype_name,col = col_name)
                                                                                                                                                                                                                                                                  if (!is.null(main)){
                                                                                                                                                                                                                                                                    p <- p + ggtitle(main) + theme(plot.title = element_text(face = "bold", hjust = 0.5, size = fsize))
                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                  if (censor.marks & type == "KM")
                                                                                                                                                                                                                                                                  p <- p + geom_point(data = subset(df, n.censor > 0),
                                                                                                                                                                                                                                                                  aes(x = time, y = surv, group = strata, col = strata),
                                                                                                                                                                                                                                                                  shape = 3, size = censor.size, stroke = censor.stroke,
                                                                                                                                                                                                                                                                  show.legend = F)
                                                                                                                                                                                                                                                                  if (pval & type == "KM" & multiple_lines) {
                                                                                                                                                                                                                                                                    sdiff <- survival::survdiff(eval(sfit$call$formula),
                                                                                                                                                                                                                                                                    data = eval(sfit$call$data))
                                                                                                                                                                                                                                                                    pval <- pchisq(sdiff$chisq, length(sdiff$n) - 1, lower.tail = FALSE)
                                                                                                                                                                                                                                                                    pvaltxt <- lpvalue2(pval, pval.digits)
                                                                                                                                                                                                                                                                    pvaltxt <- paste(pvaltxt, "(Log Rank)")
                                                                                                                                                                                                                                                                    if (is.null(pval.pos)) {
                                                                                                                                                                                                                                                                      p <- p + annotate("text", x = 0.85 * max(times),
                                                                                                                                                                                                                                                                      y = ylim[1], label = pvaltxt, size = psize)
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                    else p <- p + annotate("text", x = pval.pos[1], y = pval.pos[2],
                                                                                                                                                                                                                                                                    label = pvaltxt, size = psize)
                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                  if (!is.null(cov) & pval & type == "CIF") {
                                                                                                                                                                                                                                                                    if (length(plot.event) == 1) {
                                                                                                                                                                                                                                                                      test <- test[rownames(test) == plot.event, ]
                                                                                                                                                                                                                                                                      pval <- test[2]
                                                                                                                                                                                                                                                                      pvaltxt <- lpvalue2(pval, pval.digits)
                                                                                                                                                                                                                                                                      pvaltxt <- paste(pvaltxt, "(Gray's test)")
                                                                                                                                                                                                                                                                      if (is.null(pval.pos)) {
                                                                                                                                                                                                                                                                        p <- p + annotate("text", x = 0.85 * max(times),
                                                                                                                                                                                                                                                                        y = ylim[1], label = pvaltxt, size = psize)
                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                      else p <- p + annotate("text", x = pval.pos[1],
                                                                                                                                                                                                                                                                      y = c(pval.pos[2]), label = pvaltxt, size = psize)
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                    else {
                                                                                                                                                                                                                                                                      pval <- test[, 2]
                                                                                                                                                                                                                                                                      pvaltxt <- sapply(pval, lpvalue2, pval.digits)
                                                                                                                                                                                                                                                                      pvaltxt <- c("Gray's test", paste(eventlabs, pvaltxt))
                                                                                                                                                                                                                                                                      if (is.null(pval.pos)) {
                                                                                                                                                                                                                                                                        p <- p + annotate("text", x = 0.85 * max(df$time),
                                                                                                                                                                                                                                                                        y = c(0.12, 0.08, 0.04), label = pvaltxt,
                                                                                                                                                                                                                                                                        size = psize)
                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                      else p <- p + annotate("text", x = pval.pos[1],
                                                                                                                                                                                                                                                                      y = c(pval.pos[2], pval.pos[2] - 0.04, pval.pos[2] -
                                                                                                                                                                                                                                                                        0.08), label = pvaltxt, size = psize)
                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                    if (median.text & !multiple_lines) {
                                                                                                                                                                                                                                                                      median_txt <- paste0("Median=", median_txt)
                                                                                                                                                                                                                                                                      if (length(plot.event) == 2)
                                                                                                                                                                                                                                                                      median_txt <- paste(paste0(eventlabs, ":", median_txt),
                                                                                                                                                                                                                                                                      collapse = "\n")
                                                                                                                                                                                                                                                                      if (is.null(median.pos) & type == "KM")
                                                                                                                                                                                                                                                                      median.pos <- c(0.1 * max(times), ylim[1])
                                                                                                                                                                                                                                                                      if (is.null(median.pos) & type == "CIF")
                                                                                                                                                                                                                                                                      median.pos <- c(0.1 * max(times), ylim[2] * 0.95)
                                                                                                                                                                                                                                                                      p <- p + annotate("text", x = median.pos[1], y = median.pos[2],
                                                                                                                                                                                                                                                                      label = median_txt, size = median.size)
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                    if (!is.null(set.time.text) & !multiple_lines) {
                                                                                                                                                                                                                                                                      if (length(plot.event) == 2)
                                                                                                                                                                                                                                                                      set.surv.text <- paste(paste0(eventlabs, ":", set.surv.text),
                                                                                                                                                                                                                                                                      collapse = "\n")
                                                                                                                                                                                                                                                                      if (is.null(set.pos) & type == "KM")
                                                                                                                                                                                                                                                                      set.pos <- c(0.1 * max(times), ylim[1] + 0.1)
                                                                                                                                                                                                                                                                      if (is.null(set.pos) & type == "CIF")
                                                                                                                                                                                                                                                                      set.pos <- c(0.1 * max(times), ylim[2] * 0.85)
                                                                                                                                                                                                                                                                      p <- p + annotate("text", x = set.pos[1], y = set.pos[2],
                                                                                                                                                                                                                                                                      label = set.surv.text, size = set.size)
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                    if (median.lines) {
                                                                                                                                                                                                                                                                      temp <- data.frame(x = median_vals, y = 0.5)
                                                                                                                                                                                                                                                                      p <- p + geom_segment(data = temp, aes(x = x, xend = x,
                                                                                                                                                                                                                                                                        y = 0, yend = 0.5), lty = 2, lwd = median.lsize)
                                                                                                                                                                                                                                                                        temp2 <- data.frame(x = max(median_vals, na.rm = TRUE),
                                                                                                                                                                                                                                                                        y = 0.5)
                                                                                                                                                                                                                                                                        p <- p + geom_segment(data = temp2, aes(x = 0, xend = x,
                                                                                                                                                                                                                                                                          y = 0.5, yend = 0.5), lty = 2, lwd = median.lsize)
                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                        if (set.time.line) {
                                                                                                                                                                                                                                                                          set.surv$y <- as.numeric(sub(" *\\(.*", "", set.surv$set.CI))
                                                                                                                                                                                                                                                                          set.surv$time[is.na(set.surv$y)] <- NA
                                                                                                                                                                                                                                                                          p <- p + geom_segment(data = set.surv, aes(x = 0, xend = time,
                                                                                                                                                                                                                                                                            y = y, yend = y), lty = 2, lwd = set.lsize)
                                                                                                                                                                                                                                                                            p <- p + geom_segment(data = set.surv, aes(x = time,
                                                                                                                                                                                                                                                                              xend = time, y = 0, yend = y), lty = 2, lwd = set.lsize)
                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                            if (multiple_lines == T & (length(plot.event) == 1 | event ==
                                                                                                                                                                                                                                                                            "linetype")) {
                                                                                                                                                                                                                                                                              col_labs <- stratalabs
                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                            else col_labs <- eventlabs
                                                                                                                                                                                                                                                                            p <- p + scale_colour_manual(values = col, labels = col_labs)
                                                                                                                                                                                                                                                                            p <- p + scale_fill_manual(values = col, labels = col_labs)
                                                                                                                                                                                                                                                                            if (multiple_lines == T & (length(plot.event) == 1 | event ==
                                                                                                                                                                                                                                                                            "col")) {
                                                                                                                                                                                                                                                                              linetype_labs <- stratalabs
                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                            else linetype_labs <- eventlabs
                                                                                                                                                                                                                                                                            if (!is.null(linetype))
                                                                                                                                                                                                                                                                            p <- p + scale_linetype_manual(labels = linetype_labs,
                                                                                                                                                                                                                                                                              values = linetype)
                                                                                                                                                                                                                                                                              if (is.null(linetype))
                                                                                                                                                                                                                                                                              p <- p + scale_linetype_discrete(labels = linetype_labs)
                                                                                                                                                                                                                                                                              if (event == "linetype" & length(plot.event) == 2 & multiple_lines ==
                                                                                                                                                                                                                                                                              F) {
                                                                                                                                                                                                                                                                                p <- p + guides(col = F)
                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                              if (event == "col" & length(plot.event) == 2 & multiple_lines ==
                                                                                                                                                                                                                                                                              F) {
                                                                                                                                                                                                                                                                                p <- p + guides(linetype = F)
                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                              if (table) {
                                                                                                                                                                                                                                                                                blank.pic <- ggplot(df, aes(time, surv)) + geom_blank() +
                                                                                                                                                                                                                                                                                theme_bw() + scale_x_continuous(breaks = times,
                                                                                                                                                                                                                                                                                  limits = c(0, maxxval)) + theme(axis.text.x = element_blank(),
                                                                                                                                                                                                                                                                                  axis.text.y = element_blank(), axis.title.x = element_blank(),
                                                                                                                                                                                                                                                                                  axis.title.y = element_blank(), axis.ticks = element_blank(),
                                                                                                                                                                                                                                                                                  panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                                                                                                                                                                                                                                                                                  panel.border = element_blank(), panel.background = element_rect(fill = "transparent"))
                                                                                                                                                                                                                                                                                  sfit.summary <- summary(sfit, times = times, extend = TRUE)
                                                                                                                                                                                                                                                                                  risk.data <- data.frame(strata = if (multiple_lines) {
                                                                                                                                                                                                                                                                                    sfit.summary$strata
                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                  else factor("All"), time = sfit.summary$time, n.risk = sfit.summary$n.risk)
                                                                                                                                                                                                                                                                                  risk.data$strata <- factor(risk.data$strata, levels = rev(levels(risk.data$strata)))
                                                                                                                                                                                                                                                                                  if (!is.null(col)) {
                                                                                                                                                                                                                                                                                    cols1 <- col
                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                  else {
                                                                                                                                                                                                                                                                                    cols1 <- .extract_ggplot_colors(p, grp.levels = stratalabs)
                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                  if (multiple_lines == F | (event == "col" & length(plot.event) >
                                                                                                                                                                                                                                                                                  1))
                                                                                                                                                                                                                                                                                  n_strata <- length(stratalabs)
                                                                                                                                                                                                                                                                                  yticklabs <- unname(rev(stratalabs.table))
                                                                                                                                                                                                                                                                                  data.table <- ggplot(risk.data, aes(x = time, y = strata,
                                                                                                                                                                                                                                                                                    label = format(n.risk, nsmall = 0))) + geom_text(hjust = "middle",
                                                                                                                                                                                                                                                                                    vjust = "center", size = nsize) + theme_bw() + scale_x_continuous(Numbers_at_risk_text,
                                                                                                                                                                                                                                                                                      breaks = times, limits = c(0, maxxval)) + coord_cartesian(xlim = c(0,
                                                                                                                                                                                                                                                                                        maxxlim)) + theme(legend.position = "none") + theme(text = element_text(size = fsize)) +
                                                                                                                                                                                                                                                                                        theme(plot.margin = unit(c(-0.5, 0.4, 0.1, 0.2), "lines")) +
                                                                                                                                                                                                                                                                                        scale_y_discrete(strataname.table, breaks = as.character(levels(risk.data$strata)),
                                                                                                                                                                                                                                                                                        labels = yticklabs)
                                                                                                                                                                                                                                                                                        data.table <- data.table + suppressWarnings(theme(axis.title.x = element_text(size = fsize,
                                                                                                                                                                                                                                                                                          vjust = 1), panel.grid.major = element_blank(),
                                                                                                                                                                                                                                                                                          panel.grid.minor = element_blank(), panel.border = element_blank(),
                                                                                                                                                                                                                                                                                          axis.text.x = element_blank(), axis.ticks = element_blank(),
                                                                                                                                                                                                                                                                                          axis.text.y = element_text(face = "bold", hjust = 1,
                                                                                                                                                                                                                                                                                          colour = rev(cols1))))
                                                                                                                                                                                                                                                                                          if (all(as.character(yticklabs) == "-"))
                                                                                                                                                                                                                                                                                          data.table <- .set_large_dash_as_ytext(data.table)
                                                                                                                                                                                                                                                                                          gA <- ggplotGrob(p)
                                                                                                                                                                                                                                                                                          gC <- ggplotGrob(data.table)
                                                                                                                                                                                                                                                                                          maxWidth = grid::unit.pmax(gA$widths[2:5], gC$widths[2:5])
                                                                                                                                                                                                                                                                                          gA$widths[2:5] <- as.list(maxWidth)
                                                                                                                                                                                                                                                                                          gC$widths[2:5] <- as.list(maxWidth)
                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                          if (is.null(table.height)){
                                                                                                                                                                                                                                                                                            rel.height.table <- length(levels(risk.data$strata)) / 20
                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                          if (!is.null(table.height)){
                                                                                                                                                                                                                                                                                            rel.height.table <- table.height
                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                          p_combined <- cowplot::plot_grid(gA, gC, nrow = 2, ncol = 1, rel_heights = c(1,rel.height.table))
                                                                                                                                                                                                                                                                                          if (returns){
                                                                                                                                                                                                                                                                                            return(list(plot=p,table=data.table))
                                                                                                                                                                                                                                                                                          } else     return(p_combined)
                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                          p
                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                      #' Additional parameters passed to ggkmcif2
                                                                                                                                                                                                                                                                                      #'
                                                                                                                                                                                                                                                                                      #' This section documents the additional parameters for \link{ggkmcif2}.
                                                                                                                                                                                                                                                                                      #'
                                                                                                                                                                                                                                                                                      #' @param HR boolean to specify if you want hazard ratios included in the plot
                                                                                                                                                                                                                                                                                      #' @param HR_pval boolean to specify if you want HR p-values in the plot
                                                                                                                                                                                                                                                                                      #' @param conf.type One of "none"(the default), "plain", "log" , "log-log" or
                                                                                                                                                                                                                                                                                      #'   "logit". Only enough of the string to uniquely identify it is necessary.
                                                                                                                                                                                                                                                                                      #'   The first option causes confidence intervals not to be generated. The
                                                                                                                                                                                                                                                                                      #'   second causes the standard intervals curve +- k *se(curve), where k is
                                                                                                                                                                                                                                                                                      #'   determined from conf.int. The log option calculates intervals based on
                                                                                                                                                                                                                                                                                      #'   the cumulative hazard or log(survival). The log-log option bases the
                                                                                                                                                                                                                                                                                      #'   intervals on the log hazard or log(-log(survival)), and the logit option
                                                                                                                                                                                                                                                                                      #'   on log(survival/(1-survival)).
                                                                                                                                                                                                                                                                                      #' @param table.height Relative height of risk table (0-1)
                                                                                                                                                                                                                                                                                      #' @param main String corresponding to main title. When NULL uses Kaplan-Meier
                                                                                                                                                                                                                                                                                      #'   Plot s, and "Cumulative Incidence Plot for CIF"
                                                                                                                                                                                                                                                                                      #'
                                                                                                                                                                                                                                                                                      #' @param stratalabs string corresponding to the labels of the covariate, when
                                                                                                                                                                                                                                                                                      #'   NULL will use the levels of the covariate
                                                                                                                                                                                                                                                                                      #' @param strataname String of the covariate name default is  nicename(cov)
                                                                                                                                                                                                                                                                                      #' @param stratalabs.table String corresponding to the levels of the covariate
                                                                                                                                                                                                                                                                                      #'   for the number at risk table, when NULL will use the levels of the
                                                                                                                                                                                                                                                                                      #'   covariate. Can use a string of "-" when the labels are long
                                                                                                                                                                                                                                                                                      #' @param strataname.table String of the covariate name for the number at risk
                                                                                                                                                                                                                                                                                      #'   table default is  nicename(cov
                                                                                                                                                                                                                                                                                      #'
                                                                                                                                                                                                                                                                                      #' @param median.text boolean to specify if you want the median values added
                                                                                                                                                                                                                                                                                      #'   to the legend (or as added text if there are no covariates), for KM only
                                                                                                                                                                                                                                                                                      #' @param median.lines boolean to specify if you want the median values added
                                                                                                                                                                                                                                                                                      #'   as lines to the plot, for KM only
                                                                                                                                                                                                                                                                                      #' @param median.CI boolean to specify if you want the 95\% confidence
                                                                                                                                                                                                                                                                                      #'   interval with the median text (Only for KM)
                                                                                                                                                                                                                                                                                      #' @param set.time.text string for the text to add survival at a specified
                                                                                                                                                                                                                                                                                      #'   time (eg. year OS)
                                                                                                                                                                                                                                                                                      #' @param set.time.line boolean to specify if you want the survival added as
                                                                                                                                                                                                                                                                                      #'   lines to the plot at a specified point
                                                                                                                                                                                                                                                                                      #' @param set.time Numeric values of the specific time of interest, default is
                                                                                                                                                                                                                                                                                      #'   5 (Multiple values can be entered)
                                                                                                                                                                                                                                                                                      #' @param set.time.CI boolean to specify if you want the 95\% confidence
                                                                                                                                                                                                                                                                                      #'   interval with the set time text
                                                                                                                                                                                                                                                                                      #'
                                                                                                                                                                                                                                                                                      #' @param censor.marks logical value. If TRUE, includes censor marks (only for
                                                                                                                                                                                                                                                                                      #'   KM curves)
                                                                                                                                                                                                                                                                                      #' @param censor.size size of censor marks, default is 3
                                                                                                                                                                                                                                                                                      #' @param censor.stroke stroke of censor marks, default is 1.5
                                                                                                                                                                                                                                                                                      #' @param fsize font size
                                                                                                                                                                                                                                                                                      #' @param nsize font size for numbers in the numbers at risk table
                                                                                                                                                                                                                                                                                      #' @param lsize line size
                                                                                                                                                                                                                                                                                      #' @param psize size of the pvalue
                                                                                                                                                                                                                                                                                      #' @param median.size size of the median text (Only when there are no
                                                                                                                                                                                                                                                                                      #'   covariates)
                                                                                                                                                                                                                                                                                      #' @param median.pos vector of length 2 corresponding to the median position
                                                                                                                                                                                                                                                                                      #'   (Only when there are no covariates)
                                                                                                                                                                                                                                                                                      #' @param median.lsize line size of the median lines
                                                                                                                                                                                                                                                                                      #' @param set.size size of the survival at a set time text (Only when there
                                                                                                                                                                                                                                                                                      #'   are no covariates)
                                                                                                                                                                                                                                                                                      #' @param set.pos  vector of length 2 corresponding to the survival at a set
                                                                                                                                                                                                                                                                                      #'   point position (Only when there are no covariates)
                                                                                                                                                                                                                                                                                      #' @param set.lsize line size of the survival at set points
                                                                                                                                                                                                                                                                                      #' @param ylim vector of length 2 corresponding to limits of y-axis. Default
                                                                                                                                                                                                                                                                                      #'   to NULL
                                                                                                                                                                                                                                                                                      #' @param linetype vector of line types; default is solid for all lines
                                                                                                                                                                                                                                                                                      #' @param xlim  vector of length 2 corresponding to limits of x-axis. Default
                                                                                                                                                                                                                                                                                      #'   to NULL
                                                                                                                                                                                                                                                                                      #' @param legend.pos Can be either a string corresponding to the legend
                                                                                                                                                                                                                                                                                      #'   position ("left","top", "right", "bottom", "none") or a vector of length
                                                                                                                                                                                                                                                                                      #'   2 corresponding to the legend position (uses normalized units (ie the
                                                                                                                                                                                                                                                                                      #'   c(0.5,0.5) is the middle of the plot))
                                                                                                                                                                                                                                                                                      #' @param pval.pos  vector of length 2 corresponding to the p-value position
                                                                                                                                                                                                                                                                                      #' @param event String specifying if the event should be mapped to the colour,
                                                                                                                                                                                                                                                                                      #'   or linetype when plotting both events to colour = "col", line type
                                                                                                                                                                                                                                                                                      #' @param flip.CIF boolean to flip the CIF curve to start at 1
                                                                                                                                                                                                                                                                                      #' @param cut numeric value indicating where to divide a continuous covariate
                                                                                                                                                                                                                                                                                      #'   (default is the median)
                                                                                                                                                                                                                                                                                      #' @param eventlabs String corresponding to the event type names
                                                                                                                                                                                                                                                                                      #' @param event.name String corresponding to the label of the event types
                                                                                                                                                                                                                                                                                      #' @param Numbers_at_risk_text String for the label of the number at risk
                                                                                                                                                                                                                                                                                      #' @param HR.digits Number of digits printed of the  hazard ratio
                                                                                                                                                                                                                                                                                      #' @param HR.pval.digits Number of digits printed of the hazard ratio pvalue
                                                                                                                                                                                                                                                                                      #' @param pval.digits Number of digits printed of the Gray's/log rank pvalue
                                                                                                                                                                                                                                                                                      #'
                                                                                                                                                                                                                                                                                      #' @param median.digits Number of digits printed of the median pvalue
                                                                                                                                                                                                                                                                                      #' @param set.time.digits Number of digits printed of the probability at a
                                                                                                                                                                                                                                                                                      #'   specified time
                                                                                                                                                                                                                                                                                      #' @param print.n.missing Logical, should the number of missing be shown
                                                                                                                                                                                                                                                                                      #'   !Needs to be checked
                                                                                                                                                                                                                                                                                      #' @param returns Logical, if TRUE a list contain the plot and at risk table
                                                                                                                                                                                                                                                                                      #'   is returned
                                                                                                                                                                                                                                                                                      #'
                                                                                                                                                                                                                                                                                      #' @name ggkmcif2Parameters_2025
                                                                                                                                                                                                                                                                                      #' @keywords internal
                                                                                                                                                                                                                                                                                      ggkmcif2Parameters_2025 <- function(table.height = NULL,
                                                                                                                                                                                                                                                                                        HR = FALSE, HR_pval = FALSE,  conf.type = "log",
                                                                                                                                                                                                                                                                                        main = NULL, stratalabs = NULL, strataname,
                                                                                                                                                                                                                                                                                        stratalabs.table = NULL, strataname.table = strataname,
                                                                                                                                                                                                                                                                                        median.text = FALSE, median.lines = FALSE, median.CI = FALSE,
                                                                                                                                                                                                                                                                                        set.time.text = NULL, set.time.line = FALSE, set.time = 5,
                                                                                                                                                                                                                                                                                        set.time.CI = FALSE, censor.marks = TRUE, censor.size = 3,
                                                                                                                                                                                                                                                                                        censor.stroke = 1.5, fsize = 11, nsize = 3, lsize = 1, psize = 3.5,
                                                                                                                                                                                                                                                                                        median.size = 3, median.pos = NULL, median.lsize = 1, set.size = 3,
                                                                                                                                                                                                                                                                                        set.pos = NULL, set.lsize = 1, ylim = c(0, 1),
                                                                                                                                                                                                                                                                                        linetype = NULL, xlim = NULL, legend.pos = NULL, pval.pos = NULL,
                                                                                                                                                                                                                                                                                        event = c("col", "linetype"), flip.CIF = FALSE,
                                                                                                                                                                                                                                                                                        cut = NULL, eventlabs = NULL, event.name = NULL, Numbers_at_risk_text = "Number at risk",
                                                                                                                                                                                                                                                                                        HR.digits = 2, HR.pval.digits = 3, pval.digits = 3, median.digits = 3,
                                                                                                                                                                                                                                                                                        set.time.digits = 3, print.n.missing = TRUE,returns=FALSE){
                                                                                                                                                                                                                                                                                          return(as.list(environment(), all=TRUE))
                                                                                                                                                                                                                                                                                        }
